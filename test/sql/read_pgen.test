# name: test/sql/read_pgen.test
# description: Positive tests for read_pgen table function
# group: [plinking_duck]

require plinking_duck

# --- Basic variant metadata ---

# Row count matches variant count
query I
SELECT COUNT(*) FROM read_pgen('test/data/pgen_example.pgen');
----
4

# Variant metadata columns (ordered by CHROM then POS for deterministic output)
query TITTT
SELECT CHROM, POS, ID, REF, ALT FROM read_pgen('test/data/pgen_example.pgen') ORDER BY CHROM, POS;
----
1	10000	rs1	A	G
1	20000	rs2	C	T
1	30000	rs3	G	A
2	15000	rs4	T	C

# --- Projection pushdown (metadata-only, no PgrGet) ---

query TI
SELECT CHROM, POS FROM read_pgen('test/data/pgen_example.pgen') ORDER BY CHROM, POS;
----
1	10000
1	20000
1	30000
2	15000

query T
SELECT ID FROM read_pgen('test/data/pgen_example.pgen') ORDER BY CHROM, POS;
----
rs1
rs2
rs3
rs4

# --- Genotype column ---

# Genotype list length matches sample count
query I
SELECT len(genotypes) FROM read_pgen('test/data/pgen_example.pgen') LIMIT 1;
----
4

# Known genotype values for rs1: SAMPLE1=0/0, SAMPLE2=0/1, SAMPLE3=1/1, SAMPLE4=./.
query TT
SELECT ID, genotypes FROM read_pgen('test/data/pgen_example.pgen') WHERE ID = 'rs1';
----
rs1	[0, 1, 2, NULL]

# Known genotype values for rs2: SAMPLE1=0/1, SAMPLE2=0/1, SAMPLE3=0/0, SAMPLE4=1/1
query TT
SELECT ID, genotypes FROM read_pgen('test/data/pgen_example.pgen') WHERE ID = 'rs2';
----
rs2	[1, 1, 0, 2]

# Known genotype values for rs3: SAMPLE1=1/1, SAMPLE2=./., SAMPLE3=0/1, SAMPLE4=0/0
query TT
SELECT ID, genotypes FROM read_pgen('test/data/pgen_example.pgen') WHERE ID = 'rs3';
----
rs3	[2, NULL, 1, 0]

# Known genotype values for rs4: SAMPLE1=0/0, SAMPLE2=0/0, SAMPLE3=0/1, SAMPLE4=1/1
query TT
SELECT ID, genotypes FROM read_pgen('test/data/pgen_example.pgen') WHERE ID = 'rs4';
----
rs4	[0, 0, 1, 2]

# Missing genotype produces NULL in list (4th sample of rs1)
query I
SELECT genotypes[4] FROM read_pgen('test/data/pgen_example.pgen') WHERE ID = 'rs1';
----
NULL

# Genotype values are only 0, 1, 2, or NULL
query I
SELECT COUNT(*) FROM read_pgen('test/data/pgen_example.pgen')
WHERE list_contains(genotypes, 3);
----
0

# --- All-missing genotypes ---

query TT
SELECT ID, genotypes FROM read_pgen('test/data/all_missing.pgen') ORDER BY POS;
----
rs_miss1	[NULL, NULL]
rs_miss2	[NULL, NULL]

# --- Explicit pvar/psam paths ---

query I
SELECT COUNT(*) FROM read_pgen('test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.pvar',
    psam := 'test/data/pgen_example.psam');
----
4

# --- Optional .psam (index-only mode) ---

# read_pgen works without .psam â€” genotype lists still work
query I
SELECT len(genotypes) FROM read_pgen('test/data/pgen_orphan.pgen') LIMIT 1;
----
4

query I
SELECT COUNT(*) FROM read_pgen('test/data/pgen_orphan.pgen');
----
4

# Variant metadata still available without .psam
query TI
SELECT CHROM, POS FROM read_pgen('test/data/pgen_orphan.pgen') ORDER BY CHROM, POS;
----
1	10000
1	20000
1	30000
2	15000

# --- Column types ---

query TTTTTT
SELECT typeof(CHROM), typeof(POS), typeof(ID), typeof(REF), typeof(ALT), typeof(genotypes)
FROM read_pgen('test/data/pgen_example.pgen') LIMIT 1;
----
VARCHAR	INTEGER	VARCHAR	VARCHAR	VARCHAR	TINYINT[]

# --- Integer sample subsetting ---

query I
SELECT len(genotypes) FROM read_pgen('test/data/pgen_example.pgen', samples := [0, 2]) LIMIT 1;
----
2

# Sample subset genotype values: samples 0 and 2 for rs1 are 0/0 and 1/1
query TT
SELECT ID, genotypes FROM read_pgen('test/data/pgen_example.pgen', samples := [0, 2]) WHERE ID = 'rs1';
----
rs1	[0, 2]

# Single sample
query TT
SELECT ID, genotypes FROM read_pgen('test/data/pgen_example.pgen', samples := [3]) WHERE ID = 'rs2';
----
rs2	[2]

# --- Integer sample subsetting without .psam (orphan mode) ---

query I
SELECT len(genotypes) FROM read_pgen('test/data/pgen_orphan.pgen', samples := [0, 2]) LIMIT 1;
----
2
