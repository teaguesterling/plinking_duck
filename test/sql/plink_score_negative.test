# name: test/sql/plink_score_negative.test
# description: Negative and edge case tests for plink_score table function
# group: [sql]

require plinking_duck

# --- File not found ---

statement error
SELECT * FROM plink_score('nonexistent.pgen',
    weights := [1.0, 0.5]);
----
plink_score

# --- Missing required weights parameter ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen');
----
weights parameter is required

# --- No arguments ---

statement error
SELECT * FROM plink_score();
----

# --- Positional weights: wrong length ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [1.0, 0.5]);
----
weights list length

# --- Empty weights list ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := []::DOUBLE[]);
----
weights list is empty

# --- ID-keyed weights: wrong struct field names ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [{'variant': 'rs1', 'a1': 'G', 'beta': 1.0}]);
----
ID-keyed weights must be

# --- Missing .psam companion ---

statement error
SELECT * FROM plink_score('test/data/pgen_orphan.pgen',
    weights := [1.0, 0.5, -0.5, 2.0]);
----
cannot find .psam or .fam

# --- Invalid sample ID ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [1.0, 0.5, -0.5, 2.0],
    samples := ['NONEXISTENT']);
----
not found

# --- Empty samples list ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [1.0, 0.5, -0.5, 2.0],
    samples := []::INTEGER[]);
----
must not be empty

# --- Duplicate sample indices ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [1.0, 0.5, -0.5, 2.0],
    samples := [0, 1, 0]);
----
duplicate sample index

# --- Out-of-range integer sample index ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [1.0, 0.5, -0.5, 2.0],
    samples := [999]);
----
sample index

# --- Invalid region format ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [1.0, 0.5, -0.5, 2.0],
    region := 'invalid');
----
region

# --- Mismatched variant count ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    pvar := 'test/data/mismatched_variants.pvar',
    weights := [1.0, 0.5, -0.5, 2.0]);
----
variant count mismatch

# --- Mismatched sample count ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    psam := 'test/data/mismatched_samples.psam',
    weights := [1.0, 0.5, -0.5, 2.0]);
----
sample count mismatch

# --- center and no_mean_imputation cannot both be true ---

statement error
SELECT * FROM plink_score('test/data/pgen_example.pgen',
    weights := [1.0, 0.5, -0.5, 2.0],
    center := true,
    no_mean_imputation := true);
----
center and no_mean_imputation cannot both be true
