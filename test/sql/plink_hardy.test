# name: test/sql/plink_hardy.test
# description: Positive tests for plink_hardy table function
# group: [sql]

require plinking_duck

# --- Basic HWE output ---

# Row count matches variant count
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen');
----
4

# --- Known-answer tests (validated against plink2 --hardy) ---
# plink2 reference command:
#   plink2 --pfile test/data/pgen_example --hardy --out ref --allow-extra-chr

# rs1: [0/0, 0/1, 1/1, ./.] → counts: 1, 1, 1 (3 obs)
# O_HET = 1/3, E_HET = 2*0.5*0.5 = 0.5, P_HWE = 1.0
query TIIIRR
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT,
       ROUND(O_HET, 6), ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs1';
----
rs1	1	1	1	0.333333	1.0

# rs2: [0/1, 0/1, 0/0, 1/1] → counts: 1, 2, 1 (4 obs)
# O_HET = 2/4 = 0.5, E_HET = 0.5, P_HWE = 1.0
query TIIIRR
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT,
       ROUND(O_HET, 6), ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs2';
----
rs2	1	2	1	0.5	1.0

# rs3: [1/1, ./., 0/1, 0/0] → counts: 1, 1, 1 (3 obs, same as rs1)
query TIIIRR
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT,
       ROUND(O_HET, 6), ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs3';
----
rs3	1	1	1	0.333333	1.0

# rs4: [0/0, 0/0, 0/1, 1/1] → counts: 2, 1, 1 (4 obs)
# O_HET = 0.25, E_HET = 2*(5/8)*(3/8) = 0.46875, P_HWE = 3/7 ≈ 0.428571
query TIIIRR
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT,
       ROUND(O_HET, 6), ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs4';
----
rs4	2	1	1	0.25	0.428571

# --- E_HET values ---

query TR
SELECT ID, ROUND(E_HET, 6)
FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs1';
----
rs1	0.5

query TR
SELECT ID, ROUND(E_HET, 6)
FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs4';
----
rs4	0.46875

# --- A1 column is the alternate allele ---

query TT
SELECT ID, A1 FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs1';
----
rs1	G

query TT
SELECT ID, A1 FROM plink_hardy('test/data/pgen_example.pgen') WHERE ID = 'rs4';
----
rs4	C

# --- Full output with all variant metadata ---

query TITTTTIIIRRR
SELECT CHROM, POS, ID, REF, ALT, A1,
       HOM_REF_CT, HET_CT, HOM_ALT_CT,
       ROUND(O_HET, 6), ROUND(E_HET, 6), ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen') ORDER BY CHROM, POS;
----
1	10000	rs1	A	G	G	1	1	1	0.333333	0.5	1.0
1	20000	rs2	C	T	T	1	2	1	0.5	0.5	1.0
1	30000	rs3	G	A	A	1	1	1	0.333333	0.5	1.0
2	15000	rs4	T	C	C	2	1	1	0.25	0.46875	0.428571

# --- Column types ---

query TTTTTTTTTRRR
SELECT typeof(CHROM), typeof(POS), typeof(ID), typeof(REF), typeof(ALT), typeof(A1),
       typeof(HOM_REF_CT), typeof(HET_CT), typeof(HOM_ALT_CT),
       typeof(O_HET), typeof(E_HET), typeof(P_HWE)
FROM plink_hardy('test/data/pgen_example.pgen') LIMIT 1;
----
VARCHAR	INTEGER	VARCHAR	VARCHAR	VARCHAR	VARCHAR	INTEGER	INTEGER	INTEGER	DOUBLE	DOUBLE	DOUBLE

# --- P_HWE bounds ---

# All p-values between 0 and 1
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen')
WHERE P_HWE < 0.0 OR P_HWE > 1.0;
----
0

# O_HET between 0 and 1
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen')
WHERE O_HET < 0.0 OR O_HET > 1.0;
----
0

# E_HET between 0 and 1
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen')
WHERE E_HET < 0.0 OR E_HET > 1.0;
----
0

# --- Genotype counts consistency ---

# HOM_REF_CT + HET_CT + HOM_ALT_CT is constant for non-missing
# (all variants should have 3 or 4 obs)
query I
SELECT COUNT(DISTINCT (HOM_REF_CT + HET_CT + HOM_ALT_CT))
FROM plink_hardy('test/data/pgen_example.pgen');
----
2

# --- Mid-p correction ---
# plink2 reference: plink2 --pfile ... --hardy midp

# Mid-p produces smaller p-values (for variants not at exact HWE)
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen', midp := true);
----
4

# rs1 mid-p: 1.0 - 0.5*(1/3)/(1/3+4/3*1/3)... = 0.7 (plink2 reference)
query TR
SELECT ID, ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen', midp := true) WHERE ID = 'rs1';
----
rs1	0.7

# rs2 mid-p: 0.657143 (plink2 reference)
query TR
SELECT ID, ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen', midp := true) WHERE ID = 'rs2';
----
rs2	0.657143

# rs4 mid-p: 0.214286 (plink2 reference)
query TR
SELECT ID, ROUND(P_HWE, 6)
FROM plink_hardy('test/data/pgen_example.pgen', midp := true) WHERE ID = 'rs4';
----
rs4	0.214286

# Mid-p values are <= standard p-values
query I
SELECT COUNT(*) FROM (
    SELECT h.P_HWE AS p_std, m.P_HWE AS p_midp
    FROM plink_hardy('test/data/pgen_example.pgen') h
    JOIN plink_hardy('test/data/pgen_example.pgen', midp := true) m
        ON h.ID = m.ID
) WHERE p_midp > p_std + 0.000001;
----
0

# --- Explicit companion files ---

query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.pvar',
    psam := 'test/data/pgen_example.psam');
----
4

# .bim companion file
query TR
SELECT ID, ROUND(P_HWE, 6) FROM plink_hardy('test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.bim') WHERE ID = 'rs1';
----
rs1	1.0

# --- Optional .psam (index-only mode) ---

query TR
SELECT ID, ROUND(P_HWE, 6) FROM plink_hardy('test/data/pgen_orphan.pgen') WHERE ID = 'rs1';
----
rs1	1.0

query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_orphan.pgen');
----
4

# --- Sample subsetting (VARCHAR) ---

# Subset to SAMPLE1 + SAMPLE2:
# rs1: [0/0, 0/1] → hom_ref=1, het=1, hom_alt=0
# O_HET = 0.5, E_HET = 0.375, P_HWE = 1.0 (plink2 reference)
query TIII
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT
FROM plink_hardy('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE2']) WHERE ID = 'rs1';
----
rs1	1	1	0

query I
SELECT HOM_REF_CT + HET_CT + HOM_ALT_CT
FROM plink_hardy('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE2']) LIMIT 1;
----
2

# --- Sample subsetting (INTEGER) ---

# Same subset by index: [0, 1] = SAMPLE1, SAMPLE2
query TIII
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT
FROM plink_hardy('test/data/pgen_example.pgen',
    samples := [0, 1]) WHERE ID = 'rs1';
----
rs1	1	1	0

# Integer subsetting on orphan .pgen (no .psam)
# rs1 with samples [0, 2]: [0/0, 1/1] → hom_ref=1, het=0, hom_alt=1 → P_HWE = 1/3
query TR
SELECT ID, ROUND(P_HWE, 6) FROM plink_hardy('test/data/pgen_orphan.pgen',
    samples := [0, 2]) WHERE ID = 'rs1';
----
rs1	0.333333

# --- Region filtering ---

# Region '1:10000-20000' includes rs1 and rs2
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen', region := '1:10000-20000');
----
2

query TI
SELECT ID, HET_CT FROM plink_hardy('test/data/pgen_example.pgen',
    region := '1:10000-20000') ORDER BY POS;
----
rs1	1
rs2	2

# Region on a different chromosome
query TR
SELECT ID, ROUND(P_HWE, 6) FROM plink_hardy('test/data/pgen_example.pgen',
    region := '2:15000-15000');
----
rs4	0.428571

# Region spanning all of chr1
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen', region := '1:1-100000');
----
3

# Empty region returns 0 rows
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen', region := '99:1-100');
----
0

# Region + sample subsetting combined
query TIII
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT
FROM plink_hardy('test/data/pgen_example.pgen',
    region := '1:10000-10000', samples := ['SAMPLE1', 'SAMPLE3']);
----
rs1	1	0	1

# --- All-missing genotypes ---

# All genotypes missing → counts are 0, stats are NULL
query TIII
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT
FROM plink_hardy('test/data/all_missing.pgen') ORDER BY POS;
----
rs_miss1	0	0	0
rs_miss2	0	0	0

query TI
SELECT ID, P_HWE IS NULL AS is_null
FROM plink_hardy('test/data/all_missing.pgen') ORDER BY POS;
----
rs_miss1	1
rs_miss2	1

query TI
SELECT ID, O_HET IS NULL AS is_null
FROM plink_hardy('test/data/all_missing.pgen') ORDER BY POS;
----
rs_miss1	1
rs_miss2	1

# --- Multi-batch scan (large dataset) ---

# Total variant count
query I
SELECT COUNT(*) FROM plink_hardy('test/data/large_example.pgen');
----
3000

# All variants have same counts (2, 2, 2) due to cycling pattern
# P_HWE = 0.480519 (plink2 reference)
query II
SELECT COUNT(*), COUNT(DISTINCT ROUND(P_HWE, 6))
FROM plink_hardy('test/data/large_example.pgen');
----
3000	1

query R
SELECT DISTINCT ROUND(P_HWE, 6) FROM plink_hardy('test/data/large_example.pgen');
----
0.480519

# No duplicate rows from thread races
query I
SELECT COUNT(*) - COUNT(DISTINCT ID) FROM plink_hardy('test/data/large_example.pgen');
----
0

# Variants span all 3 chromosomes
query TI
SELECT CHROM, COUNT(*) FROM plink_hardy('test/data/large_example.pgen')
GROUP BY CHROM ORDER BY CHROM;
----
1	1000
2	1000
3	1000

# Region filtering on large dataset
query I
SELECT COUNT(*) FROM plink_hardy('test/data/large_example.pgen', region := '1:100-1000');
----
10

# --- Composable with SQL ---

# WHERE filtering on p-value
query I
SELECT COUNT(*) FROM plink_hardy('test/data/pgen_example.pgen')
WHERE P_HWE < 0.5;
----
1

# Aggregation
query R
SELECT ROUND(AVG(P_HWE), 6) FROM plink_hardy('test/data/pgen_example.pgen');
----
0.857143

# Join with plink_freq
query TRI
SELECT f.ID, f.ALT_FREQ, h.HET_CT
FROM plink_freq('test/data/pgen_example.pgen') f
JOIN plink_hardy('test/data/pgen_example.pgen') h ON f.ID = h.ID
WHERE f.ID = 'rs1';
----
rs1	0.5	1
