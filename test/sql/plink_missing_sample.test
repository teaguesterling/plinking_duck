# name: test/sql/plink_missing_sample.test
# description: Positive tests for plink_missing table function (sample mode)
# group: [sql]

require plinking_duck

# --- Basic sample missingness ---

# Row count matches sample count
query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample');
----
4

# Full output: hand-calculated from genotypes
# SAMPLE1: present at all 4 variants → MISSING_CT=0
# SAMPLE2: missing at rs3 → MISSING_CT=1
# SAMPLE3: present at all 4 variants → MISSING_CT=0
# SAMPLE4: missing at rs1 → MISSING_CT=1
query TIIR
SELECT IID, MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample') ORDER BY IID;
----
SAMPLE1	0	4	0.0
SAMPLE2	1	3	0.25
SAMPLE3	0	4	0.0
SAMPLE4	1	3	0.25

# --- Known-answer tests ---

# SAMPLE2: missing at rs3
query IIR
SELECT MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample') WHERE IID = 'SAMPLE2';
----
1	3	0.25

# SAMPLE4: missing at rs1
query IIR
SELECT MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample') WHERE IID = 'SAMPLE4';
----
1	3	0.25

# SAMPLE1: no missing
query IIR
SELECT MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample') WHERE IID = 'SAMPLE1';
----
0	4	0.0

# --- Column types ---

query TTTTT
SELECT typeof(FID), typeof(IID), typeof(MISSING_CT), typeof(OBS_CT), typeof(F_MISS)
FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample') LIMIT 1;
----
VARCHAR	VARCHAR	INTEGER	INTEGER	DOUBLE

# --- FID is NULL when psam has no FID column ---

query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample')
WHERE FID IS NULL;
----
4

# --- Invariants ---

# MISSING_CT + OBS_CT = variant_ct (constant per sample)
query I
SELECT COUNT(DISTINCT (MISSING_CT + OBS_CT))
FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample');
----
1

query I
SELECT DISTINCT (MISSING_CT + OBS_CT)
FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample');
----
4

# F_MISS between 0 and 1
query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample')
WHERE F_MISS < 0.0 OR F_MISS > 1.0;
----
0

# --- Sample subsetting in sample mode ---

# Subset to SAMPLE1 + SAMPLE2: should produce 2 rows
query I
SELECT COUNT(*)
FROM plink_missing('test/data/pgen_example.pgen',
    mode := 'sample', samples := ['SAMPLE1', 'SAMPLE2']);
----
2

# With subset, variant_ct denominator is still 4 (all variants)
query TIIR
SELECT IID, MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/pgen_example.pgen',
    mode := 'sample', samples := ['SAMPLE1', 'SAMPLE2']) ORDER BY IID;
----
SAMPLE1	0	4	0.0
SAMPLE2	1	3	0.25

# --- Region filtering in sample mode ---

# Region '1:10000-20000' → only rs1 + rs2 are scanned (2 variants)
# SAMPLE1: present at both → MISSING_CT=0, total=2
# SAMPLE2: present at both → MISSING_CT=0, total=2
# SAMPLE4: missing at rs1 → MISSING_CT=1, total=2
query TIIR
SELECT IID, MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/pgen_example.pgen',
    mode := 'sample', region := '1:10000-20000') ORDER BY IID;
----
SAMPLE1	0	2	0.0
SAMPLE2	0	2	0.0
SAMPLE3	0	2	0.0
SAMPLE4	1	1	0.5

# --- All-missing genotypes ---

# Both samples missing at both variants
query TIIR
SELECT IID, MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/all_missing.pgen', mode := 'sample') ORDER BY IID;
----
SAMPLE1	2	0	1.0
SAMPLE2	2	0	1.0

# --- Large dataset sample mode ---

# 8 samples with cycling pattern: each sample has 750 missing out of 3000 variants
query I
SELECT COUNT(*) FROM plink_missing('test/data/large_example.pgen', mode := 'sample');
----
8

# All samples should have same missingness rate (uniform cycling)
query II
SELECT COUNT(DISTINCT MISSING_CT), COUNT(DISTINCT F_MISS)
FROM plink_missing('test/data/large_example.pgen', mode := 'sample');
----
1	1

query IIR
SELECT DISTINCT MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/large_example.pgen', mode := 'sample');
----
750	2250	0.25

# --- Composable with SQL ---

# Filter high-missingness samples
query T
SELECT IID FROM plink_missing('test/data/pgen_example.pgen', mode := 'sample')
WHERE F_MISS > 0.1 ORDER BY IID;
----
SAMPLE2
SAMPLE4
