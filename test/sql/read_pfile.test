# name: test/sql/read_pfile.test
# description: Positive tests for read_pfile table function (default mode)
# group: [sql]

require plinking_duck

# --- Prefix-based discovery ---

# Row count matches variant count
query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example');
----
4

# Variant metadata columns
query TITTT
SELECT CHROM, POS, ID, REF, ALT FROM read_pfile('test/data/pfile_example') ORDER BY CHROM, POS;
----
1	10000	rs1	A	G
1	20000	rs2	C	T
1	30000	rs3	G	A
2	15000	rs4	T	C

# --- Genotype column (LIST(TINYINT), same as read_pgen) ---

# Genotype list length matches sample count
query I
SELECT len(genotypes) FROM read_pfile('test/data/pfile_example') LIMIT 1;
----
4

# Known genotype values for rs1
query TT
SELECT ID, genotypes FROM read_pfile('test/data/pfile_example') WHERE ID = 'rs1';
----
rs1	[0, 1, 2, NULL]

# Known genotype values for rs2
query TT
SELECT ID, genotypes FROM read_pfile('test/data/pfile_example') WHERE ID = 'rs2';
----
rs2	[1, 1, 0, 2]

# Known genotype values for rs3
query TT
SELECT ID, genotypes FROM read_pfile('test/data/pfile_example') WHERE ID = 'rs3';
----
rs3	[2, NULL, 1, 0]

# Known genotype values for rs4
query TT
SELECT ID, genotypes FROM read_pfile('test/data/pfile_example') WHERE ID = 'rs4';
----
rs4	[0, 0, 1, 2]

# --- Projection pushdown ---

query TI
SELECT CHROM, POS FROM read_pfile('test/data/pfile_example') ORDER BY CHROM, POS;
----
1	10000
1	20000
1	30000
2	15000

query T
SELECT ID FROM read_pfile('test/data/pfile_example') ORDER BY CHROM, POS;
----
rs1
rs2
rs3
rs4

# --- Explicit paths ---

query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example',
    pgen := 'test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.pvar',
    psam := 'test/data/pfile_example.psam');
----
4

# Explicit psam path overrides prefix: pgen_example.psam has #IID format
# (2 columns: IID, SEX) while pfile_example.psam has #FID format
# (3 columns: FID, IID, SEX). Using tidy mode to verify the column set.
query T
SELECT DISTINCT IID
FROM read_pfile('test/data/pfile_example', tidy := true,
    psam := 'test/data/pgen_example.psam')
WHERE IID = 'SAMPLE1';
----
SAMPLE1

# --- Column types ---

query TTTTTT
SELECT typeof(CHROM), typeof(POS), typeof(ID), typeof(REF), typeof(ALT), typeof(genotypes)
FROM read_pfile('test/data/pfile_example') LIMIT 1;
----
VARCHAR	INTEGER	VARCHAR	VARCHAR	VARCHAR	TINYINT[]

# --- Region filtering (default mode) ---

# Region on chromosome 1
query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example', region := '1:10000-30000');
----
3

# Region on chromosome 2
query T
SELECT ID FROM read_pfile('test/data/pfile_example', region := '2:1-100000');
----
rs4

# Region with no matches (empty result, not error)
query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example', region := '99:1-100');
----
0

# Chromosome-only filter
query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example', region := '1');
----
3

# --- Variant filtering (default mode) ---

query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example', variants := ['rs1', 'rs2']);
----
2

query T
SELECT ID FROM read_pfile('test/data/pfile_example', variants := ['rs4']) ORDER BY ID;
----
rs4

# Integer variant indices
query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example', variants := [0, 3]);
----
2

# --- Combined region + variant filter (intersection) ---

query I
SELECT COUNT(*) FROM read_pfile('test/data/pfile_example',
    region := '1:10000-20000', variants := ['rs1', 'rs3']);
----
1

query T
SELECT ID FROM read_pfile('test/data/pfile_example',
    region := '1:10000-20000', variants := ['rs1', 'rs3']);
----
rs1

# --- Sample subsetting (default mode) ---

# By name
query I
SELECT len(genotypes) FROM read_pfile('test/data/pfile_example',
    samples := ['SAMPLE1', 'SAMPLE3']) LIMIT 1;
----
2

query TT
SELECT ID, genotypes FROM read_pfile('test/data/pfile_example',
    samples := ['SAMPLE1', 'SAMPLE3']) WHERE ID = 'rs1';
----
rs1	[0, 2]

# By integer index
query I
SELECT len(genotypes) FROM read_pfile('test/data/pfile_example', samples := [0, 2]) LIMIT 1;
----
2

query TT
SELECT ID, genotypes FROM read_pfile('test/data/pfile_example', samples := [0, 2]) WHERE ID = 'rs1';
----
rs1	[0, 2]
