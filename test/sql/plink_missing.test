# name: test/sql/plink_missing.test
# description: Positive tests for plink_missing table function (variant mode)
# group: [sql]

require plinking_duck

# --- Basic variant missingness ---

# Row count matches variant count
query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen');
----
4

# Full output with all columns
query TITTTIIR
SELECT CHROM, POS, ID, REF, ALT, MISSING_CT, OBS_CT, F_MISS
FROM plink_missing('test/data/pgen_example.pgen') ORDER BY CHROM, POS;
----
1	10000	rs1	A	G	1	3	0.25
1	20000	rs2	C	T	0	4	0.0
1	30000	rs3	G	A	1	3	0.25
2	15000	rs4	T	C	0	4	0.0

# --- Known-answer tests ---

# rs1: [0, 1, 2, NULL] → 1 missing out of 4
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen') WHERE ID = 'rs1';
----
rs1	1	3	0.25

# rs2: [1, 1, 0, 2] → 0 missing out of 4
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen') WHERE ID = 'rs2';
----
rs2	0	4	0.0

# rs3: [2, NULL, 1, 0] → 1 missing out of 4
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen') WHERE ID = 'rs3';
----
rs3	1	3	0.25

# rs4: [0, 0, 1, 2] → 0 missing out of 4
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen') WHERE ID = 'rs4';
----
rs4	0	4	0.0

# --- Column types ---

query TTTTTTTT
SELECT typeof(CHROM), typeof(POS), typeof(ID), typeof(REF), typeof(ALT),
       typeof(MISSING_CT), typeof(OBS_CT), typeof(F_MISS)
FROM plink_missing('test/data/pgen_example.pgen') LIMIT 1;
----
VARCHAR	INTEGER	VARCHAR	VARCHAR	VARCHAR	INTEGER	INTEGER	DOUBLE

# --- Invariants ---

# F_MISS between 0 and 1
query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen')
WHERE F_MISS < 0.0 OR F_MISS > 1.0;
----
0

# MISSING_CT + OBS_CT = sample_ct (constant across all variants)
query I
SELECT COUNT(DISTINCT (MISSING_CT + OBS_CT))
FROM plink_missing('test/data/pgen_example.pgen');
----
1

query I
SELECT DISTINCT (MISSING_CT + OBS_CT)
FROM plink_missing('test/data/pgen_example.pgen');
----
4

# --- Explicit companion files ---

query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.pvar',
    psam := 'test/data/pgen_example.psam');
----
4

# .bim companion file
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.bim') WHERE ID = 'rs1';
----
rs1	1	3	0.25

# --- Optional .psam (index-only mode) ---

# plink_missing variant mode works without .psam
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_orphan.pgen') WHERE ID = 'rs1';
----
rs1	1	3	0.25

query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_orphan.pgen');
----
4

# --- Sample subsetting (VARCHAR) ---

# Subset to SAMPLE1 + SAMPLE3 (0-based indices 0, 2)
# rs1: SAMPLE1=0, SAMPLE3=2 → both present → MISSING_CT=0
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE3']) WHERE ID = 'rs1';
----
rs1	0	2	0.0

# rs1 without subsetting has 1 missing (SAMPLE4)
# With SAMPLE1+SAMPLE3, neither is missing at rs1
# rs3 without subsetting: SAMPLE2 missing, but SAMPLE2 not in subset → 0 missing
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE3']) WHERE ID = 'rs3';
----
rs3	0	2	0.0

# --- Sample subsetting (INTEGER) ---

# Same subset by 0-based index: [0, 2] = SAMPLE1, SAMPLE3
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen',
    samples := [0, 2]) WHERE ID = 'rs1';
----
rs1	0	2	0.0

# Integer subsetting on orphan .pgen (no .psam)
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_orphan.pgen',
    samples := [0, 2]) WHERE ID = 'rs1';
----
rs1	0	2	0.0

# --- Region filtering ---

# Region '1:10000-20000' includes rs1 and rs2
query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen', region := '1:10000-20000');
----
2

query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen',
    region := '1:10000-20000') ORDER BY POS;
----
rs1	1	3	0.25
rs2	0	4	0.0

# Region on a different chromosome
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen',
    region := '2:15000-15000');
----
rs4	0	4	0.0

# Empty region returns 0 rows
query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen', region := '99:1-100');
----
0

# Region + sample subsetting combined
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/pgen_example.pgen',
    region := '1:10000-10000', samples := ['SAMPLE1', 'SAMPLE3']);
----
rs1	0	2	0.0

# --- All-missing genotypes ---

# All genotypes missing → MISSING_CT = sample_ct, OBS_CT = 0, F_MISS = 1.0
query TIIR
SELECT ID, MISSING_CT, OBS_CT, F_MISS FROM plink_missing('test/data/all_missing.pgen') ORDER BY POS;
----
rs_miss1	2	0	1.0
rs_miss2	2	0	1.0

# --- Multi-batch scan (large dataset) ---

# Total variant count
query I
SELECT COUNT(*) FROM plink_missing('test/data/large_example.pgen');
----
3000

# Cycling pattern: each variant has 2 missing out of 8 samples
query II
SELECT COUNT(*), COUNT(DISTINCT MISSING_CT)
FROM plink_missing('test/data/large_example.pgen');
----
3000	1

query II
SELECT DISTINCT MISSING_CT, OBS_CT FROM plink_missing('test/data/large_example.pgen');
----
2	6

# No duplicate rows from thread races
query I
SELECT COUNT(*) - COUNT(DISTINCT ID) FROM plink_missing('test/data/large_example.pgen');
----
0

# Region filtering on large dataset
query I
SELECT COUNT(*) FROM plink_missing('test/data/large_example.pgen', region := '1:100-1000');
----
10

# --- Composable with SQL ---

# WHERE filtering on missingness
query I
SELECT COUNT(*) FROM plink_missing('test/data/pgen_example.pgen')
WHERE F_MISS > 0.0;
----
2

# Aggregation: average missingness
query R
SELECT AVG(F_MISS) FROM plink_missing('test/data/pgen_example.pgen');
----
0.125
