# name: test/sql/plink_freq.test
# description: Positive tests for plink_freq table function
# group: [sql]

require plinking_duck

# --- Basic frequency output ---

# Row count matches variant count
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen');
----
4

# All variant metadata columns present in output
query TITTTRI
SELECT CHROM, POS, ID, REF, ALT, ALT_FREQ, OBS_CT
FROM plink_freq('test/data/pgen_example.pgen') ORDER BY CHROM, POS;
----
1	10000	rs1	A	G	0.5	6
1	20000	rs2	C	T	0.5	8
1	30000	rs3	G	A	0.5	6
2	15000	rs4	T	C	0.375	8

# --- Known-answer tests (hand-calculated from genotypes) ---

# rs1: genotypes [0, 1, 2, NULL] → alt_count=1+2=3, allele_obs=2*3=6, freq=3/6=0.5
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen') WHERE ID = 'rs1';
----
rs1	0.5	6

# rs2: genotypes [1, 1, 0, 2] → alt_count=1+1+2=4, allele_obs=2*4=8, freq=4/8=0.5
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen') WHERE ID = 'rs2';
----
rs2	0.5	8

# rs3: genotypes [2, NULL, 1, 0] → alt_count=2+1=3, allele_obs=6, freq=0.5
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen') WHERE ID = 'rs3';
----
rs3	0.5	6

# rs4: genotypes [0, 0, 1, 2] → alt_count=1+2=3, allele_obs=8, freq=3/8=0.375
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen') WHERE ID = 'rs4';
----
rs4	0.375	8

# --- Column types ---

query TTTTTTT
SELECT typeof(CHROM), typeof(POS), typeof(ID), typeof(REF), typeof(ALT),
       typeof(ALT_FREQ), typeof(OBS_CT)
FROM plink_freq('test/data/pgen_example.pgen') LIMIT 1;
----
VARCHAR	INTEGER	VARCHAR	VARCHAR	VARCHAR	DOUBLE	INTEGER

# --- Counts mode ---

# All genotype counts for each variant
query TIIIII
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT, MISSING_CT, OBS_CT
FROM plink_freq('test/data/pgen_example.pgen', counts := true) ORDER BY CHROM, POS;
----
rs1	1	1	1	1	6
rs2	1	2	1	0	8
rs3	1	1	1	1	6
rs4	2	1	1	0	8

# Counts column types
query TTTT
SELECT typeof(HOM_REF_CT), typeof(HET_CT), typeof(HOM_ALT_CT), typeof(MISSING_CT)
FROM plink_freq('test/data/pgen_example.pgen', counts := true) LIMIT 1;
----
INTEGER	INTEGER	INTEGER	INTEGER

# Counts sum to total sample count
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen', counts := true)
WHERE HOM_REF_CT + HET_CT + HOM_ALT_CT + MISSING_CT != 4;
----
0

# --- Explicit companion files ---

query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.pvar',
    psam := 'test/data/pgen_example.psam');
----
4

# .bim companion file
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    pvar := 'test/data/pgen_example.bim') WHERE ID = 'rs1';
----
rs1	0.5	6

# --- Optional .psam (index-only mode) ---

# plink_freq works without .psam — uses raw_sample_ct from .pgen header
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_orphan.pgen') WHERE ID = 'rs1';
----
rs1	0.5	6

query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_orphan.pgen');
----
4

# --- Sample subsetting (VARCHAR) ---

# Subset to SAMPLE1 + SAMPLE3: changes frequencies
# rs1: [0, 2] → freq = (0+2*1)/(2*2) = 0.5
# rs2: [1, 0] → freq = (1+0)/(2*2) = 0.25
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE3']) WHERE ID = 'rs1';
----
rs1	0.5	4

query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE3']) WHERE ID = 'rs2';
----
rs2	0.25	4

# rs4 with SAMPLE1+SAMPLE3: [0, 1] → freq = 1/4 = 0.25
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE3']) WHERE ID = 'rs4';
----
rs4	0.25	4

# --- Sample subsetting (INTEGER) ---

# Same subset by index: [0, 2] = SAMPLE1, SAMPLE3
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    samples := [0, 2]) WHERE ID = 'rs2';
----
rs2	0.25	4

# Integer subsetting on orphan .pgen (no .psam)
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_orphan.pgen',
    samples := [0, 2]) WHERE ID = 'rs1';
----
rs1	0.5	4

# Sample subsetting with counts
query TIIIII
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT, MISSING_CT, OBS_CT
FROM plink_freq('test/data/pgen_example.pgen',
    samples := ['SAMPLE1', 'SAMPLE3'], counts := true) WHERE ID = 'rs2';
----
rs2	1	1	0	0	4

# --- Region filtering ---

# Region '1:10000-20000' includes rs1 and rs2 (chr1, pos 10000 and 20000)
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen', region := '1:10000-20000');
----
2

query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    region := '1:10000-20000') ORDER BY POS;
----
rs1	0.5	6
rs2	0.5	8

# Region on a different chromosome
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    region := '2:15000-15000');
----
rs4	0.375	8

# Region spanning all of chr1
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen', region := '1:1-100000');
----
3

# Empty region (no matching chromosome) returns 0 rows
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen', region := '99:1-100');
----
0

# Empty region (no matching positions) returns 0 rows
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen', region := '1:1-9999');
----
0

# Region + sample subsetting combined
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/pgen_example.pgen',
    region := '1:10000-10000', samples := ['SAMPLE1', 'SAMPLE3']);
----
rs1	0.5	4

# --- All-missing genotypes ---

# All genotypes missing → OBS_CT = 0, ALT_FREQ = NULL
query TRI
SELECT ID, ALT_FREQ, OBS_CT FROM plink_freq('test/data/all_missing.pgen') ORDER BY POS;
----
rs_miss1	NULL	0
rs_miss2	NULL	0

# All-missing with counts
query TIIIII
SELECT ID, HOM_REF_CT, HET_CT, HOM_ALT_CT, MISSING_CT, OBS_CT
FROM plink_freq('test/data/all_missing.pgen', counts := true) ORDER BY POS;
----
rs_miss1	0	0	0	2	0
rs_miss2	0	0	0	2	0

# --- Frequency bounds ---

# All frequencies are between 0 and 1 (NULLs excluded by WHERE)
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen')
WHERE ALT_FREQ < 0.0 OR ALT_FREQ > 1.0;
----
0

# --- Multi-batch scan (large dataset) ---

# Total variant count
query I
SELECT COUNT(*) FROM plink_freq('test/data/large_example.pgen');
----
3000

# All variants have same frequency due to cycling pattern (2 each of hom_ref, het, hom_alt, missing)
# ALT_FREQ = (2 + 2*2) / (2*6) = 0.5, OBS_CT = 12
query II
SELECT COUNT(*), COUNT(DISTINCT ALT_FREQ)
FROM plink_freq('test/data/large_example.pgen');
----
3000	1

query RI
SELECT DISTINCT ALT_FREQ, OBS_CT FROM plink_freq('test/data/large_example.pgen');
----
0.5	12

# No duplicate rows from thread races
query I
SELECT COUNT(*) - COUNT(DISTINCT ID) FROM plink_freq('test/data/large_example.pgen');
----
0

# Variants span all 3 chromosomes
query TI
SELECT CHROM, COUNT(*) FROM plink_freq('test/data/large_example.pgen')
GROUP BY CHROM ORDER BY CHROM;
----
1	1000
2	1000
3	1000

# Region filtering on large dataset
query I
SELECT COUNT(*) FROM plink_freq('test/data/large_example.pgen', region := '1:100-1000');
----
10

query I
SELECT COUNT(*) FROM plink_freq('test/data/large_example.pgen', region := '2:100-500');
----
5

# --- Composable with SQL ---

# WHERE filtering on frequency
query I
SELECT COUNT(*) FROM plink_freq('test/data/pgen_example.pgen')
WHERE ALT_FREQ > 0.4;
----
3

# Aggregation
query R
SELECT AVG(ALT_FREQ) FROM plink_freq('test/data/pgen_example.pgen');
----
0.46875
