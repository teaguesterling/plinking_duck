# plinking_duck — Distributed Execution Plan Index

## Overview

Implementation plan for the `plinking_duck` DuckDB extension. Organized into
phases that maximize parallel execution across git worktrees.

Reference: `P0-001-core-extension-connectivity` (master technical spec)

---

## Phase Map

### P0 — Build Infrastructure (Sequential) ✓

| Plan | Title | Depends On | Branch | Status |
|------|-------|-----------|--------|--------|
| P0-001 | Master Technical Spec | — | (reference only) | ✓ Done |
| P0-002 | Template Cleanup | — | `feature/P0-002-template-cleanup` | ✓ Merged |
| P0-003 | duckhts Lessons & Patterns | — | (reference only) | ✓ Done |
| P0-004 | pgenlib Build Integration | P0-002 | `feature/P0-004-pgenlib-build` | ✓ Merged |
| P0-005 | Build Validation | P0-004 | `feature/P0-005-build-validation` | ✓ Merged |

### P1 — Reader Functions ✓

| Plan | Title | Depends On | Branch | Parallel Group | Status |
|------|-------|-----------|--------|----------------|--------|
| P1-001 | read_pvar | P0-005 | `feature/P1-001-read-pvar` | **A** | ✓ Merged (PR #4) |
| P1-002 | read_psam | P0-005 | `feature/P1-002-read-psam` | **A** | ✓ Merged (PR #5) |
| P1-003 | read_pgen | P1-001 + P1-002 | `feature/P1-003-read-pgen` | B | ✓ Merged (PR #6) |
| P1-004 | read_pfile | P1-003 | `feature/P1-004-read-pfile` | C | ✓ Merged (PR #8) |
| P1-005 | Integration & Documentation | P1-004 | `feature/P1-005-integration` | — | ✓ Merged (PR #9) |
| P1-006 | P2 Utility Function Planning | — (plans only) | `feature/P1-006-p2-planning` | **A** (parallel with all P1) | ✓ Done (PR #3) |

#### P1 Follow-up

| Issue | Title | Branch | Status |
|-------|-------|--------|--------|
| #7 | Test coverage gaps & CI fixes | `issue/7-P1-003-test-coverage-gaps-and-ci` | ✓ Merged (PR #10) |

PR #10 added read_pgen test coverage, fixed the CI zlib dependency, added a
musl rawmemchr shim, and excluded non-Linux platforms (macOS, Windows, WASM,
musl) from CI due to pre-existing plink-ng portability issues.

### P2 — Utility Functions ✓

Planned by P1-006. Five functions approved after surveying plink2's full
analytical command set. See `P1-006-research-summary` for the complete
survey, evaluation criteria, and deferred candidates.

| Plan | Title | Depends On | Branch | Parallel Group | Status |
|------|-------|-----------|--------|----------------|--------|
| P2-001 | plink_freq (allele frequencies) | P1-003 | `feature/P2-001-plink-freq` | **A** (first — creates shared infra) | ✓ Merged (PR #12) |
| P2-002 | plink_hardy (HWE exact test) | P2-001 | `feature/P2-002-plink-hardy` | **B** | ✓ Merged (PR #14) |
| P2-003 | plink_missing (missingness rates) | P2-001 | `feature/P2-003-plink-missing` | **B** | ✓ Merged (PR #15) |
| P2-004 | plink_ld (linkage disequilibrium) | P2-001 | `feature/P2-004-plink-ld` | **B** | ✓ Merged (PR #16) |
| P2-005 | plink_score (polygenic scoring) | P2-001 | `feature/P2-005-plink-score` | **B** | ✓ Merged (PR #17) |

**P2 complete** — all five utility functions implemented and merged. Shared
infrastructure (AlignedBuffer, SampleSubset, VariantRange, companion file
discovery) in `plink_common.hpp/cpp`. Dosage mode deferred (no test data).

### P3 — Advanced Functions (Future)

Deferred by P1-006. Candidates requiring external libraries (LAPACK/BLAS),
O(N²) computation, or complex input models:

| Candidate | Reason Deferred | Estimated Complexity |
|-----------|----------------|---------------------|
| plink_glm (association) | Needs regression library | High |
| plink_pca (PCA) | Needs LAPACK eigendecomposition | High |
| plink_king_table (kinship) | O(N²) pairwise computation | High |
| plink_het (heterozygosity) | Expressible via plink_freq + SQL | Low |
| plink_fst (FST) | Specialized population genetics use | Medium |

---

## Dependency Graph

```
P0-002 ──→ P0-004 ──→ P0-005
              │           │
           P0-003         │           P0-003 = duckhts lessons
         (reference)      │           (informs P0-004, P1-003, P1-004)
                          │
              ┌───────────┴───────────┐
              │                       │
           P1-001                  P1-002        ← P1 Parallel Group A
        (read_pvar)             (read_psam)        (separate worktrees)
              │                       │
              └───────────┬───────────┘
                          │ merge                    P1-006
                       P1-003                    (P2 planning)
                    (read_pgen)                  runs in parallel
                          │                      with all P1 work;
                       P1-004                    produces P2-00X
                    (read_pfile)                 plan documents
                          │
                       P1-005
                  (integration & docs)
                          │
                          │ (P2 begins after P1 complete)
                          │
                       P2-001 ←────────── extracts shared infra
                    (plink_freq)           from read_pgen into
                          │                plink_common.hpp/cpp
              ┌───────┬───┴───┬───────┐
              │       │       │       │
           P2-002  P2-003  P2-004  P2-005  ← P2 Parallel Group B
          (hardy) (missing) (ld)  (score)    (independent worktrees)
```

---

## Parallel Execution Strategy

### Group A: P1-001 + P1-002 (independent worktrees)

These two tasks modify completely different files:

| Concern | P1-001 (pvar) | P1-002 (psam) |
|---------|---------------|---------------|
| Source | `src/pvar_reader.cpp` | `src/psam_reader.cpp` |
| Header | `src/include/pvar_reader.hpp` | `src/include/psam_reader.hpp` |
| Tests | `test/sql/read_pvar.test` | `test/sql/read_psam.test` |
| Data | `test/data/*.pvar`, `*.bim` | `test/data/*.psam`, `*.fam` |

**Conflict point**: Both add a registration call to `plinking_duck_extension.cpp`.
**Resolution**: Each reader exposes a `RegisterXxxReader(ExtensionLoader &loader)`
function. The merge adds both calls to `LoadInternal()`. This is a trivial,
predictable merge conflict.

### Group B: P1-003 (after Group A merge)

Depends on shared parsing utilities from P1-001 and P1-002 — specifically the
.pvar and .psam parsing logic that `read_pgen` reuses in its bind phase to
discover variant metadata and sample information.

### Group C: P1-004 (after Group B merge)

Unifies all three readers. Adds tidy mode, sample subsetting, and region
filtering.

### P2 Group A: P2-001 (shared infrastructure + plink_freq)

P2-001 runs first because it:
1. Extracts shared utilities from `pgen_reader.cpp` into `plink_common.hpp/cpp`
2. Refactors `read_pgen` to use the shared utilities (no regressions)
3. Implements `plink_freq` as the first utility function

### P2 Group B: P2-002 + P2-003 + P2-004 + P2-005 (independent worktrees)

After P2-001 merges, these four functions modify completely different files:

| Concern | P2-002 (hardy) | P2-003 (missing) | P2-004 (ld) | P2-005 (score) |
|---------|---------------|-----------------|-------------|----------------|
| Source | `src/plink_hardy.cpp` | `src/plink_missing.cpp` | `src/plink_ld.cpp` | `src/plink_score.cpp` |
| Header | `src/include/plink_hardy.hpp` | `src/include/plink_missing.hpp` | `src/include/plink_ld.hpp` | `src/include/plink_score.hpp` |
| Tests | `test/sql/plink_hardy.test` | `test/sql/plink_missing*.test` | `test/sql/plink_ld*.test` | `test/sql/plink_score*.test` |
| pgenlib | `PgrGetCounts()` | `PgrGetMissingness()` | `PgrGet()`/`PgrGetP()` | `PgrGetD()` |

**Conflict point**: All four add a registration call to `plinking_duck_extension.cpp`.
**Resolution**: Same as P1 — each exposes a `RegisterPlinkXxx(ExtensionLoader &loader)`
function. Merge conflicts are trivial.

---

## Merge Strategy

1. Each plan executes on its own branch, forked from the feature branch.
2. Upon completion and validation, merge back into
   `feature/P1-001-core-extension-connectivity`.
3. For Group A, merge order is irrelevant (no file conflicts except the
   trivial registration point).
4. After each merge, run full test suite to catch integration issues.

---

## Conventions

### Cross-cutting design guide

See `DESIGN-GUIDE` for API design philosophy and coding standards that apply
across all phases: parameter naming, output column conventions, three-tier
type dispatch, extension scope boundary, pgenlib patterns, and scale guidance.

### Each plan includes
- Goal and scope
- Prerequisites
- File manifest (create / modify / delete)
- Implementation specification
- Testing (positive, negative, edge cases)
- Documentation updates
- Acceptance criteria

### Testing standards
- Every reader has both format-specific tests (.pvar/.bim, .psam/.fam)
- Negative tests cover: missing files, malformed data, type mismatches,
  truncated files, empty files, encoding edge cases
- All tests use DuckDB's `.test` format with `require plinking_duck`

### Documentation standards
- Each reader's public interface documented in README.md
- Inline code comments for non-obvious logic only
- Test files serve as usage examples
